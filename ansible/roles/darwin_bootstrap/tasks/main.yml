---
# tasks file for darwin_bootstrap

- name: Include role to set up ansible if needed
  include_role:
    name: ../roles/ansible_setup
  when: ansible_env.ANSIBLE_CONFIG is not defined
  tags: always

- name: Create needed directories
  file:
    name: "{{ item }}"
    state: directory
  with_items:
    - "{{ directories }}"
  tags: always

- name: Check for GITHUB_API_TOKEN in environment
  debug:
    msg: >-
      GITHUB_API_TOKEN is required in your environment.
      Please navigate to https://github.com/settings/tokens/new in your browser and create a new personal access token with
      the 'admin:public_key' scope and source GITHUB_API_TOKEN in your environment.
  failed_when: ansible_env.GITHUB_API_TOKEN is not defined
  tags:
    - git
    - ssh

- name: Include SSH setup tasks
  include_tasks: ssh_config.yml
  tags:
    - git
    - ssh

- name: Include git-related tasks
  include_tasks: git.yml
  tags: git

- name: Include shell configuration tasks
  include_tasks: shell_config.yml
  tags: shell

- name: Check if xcode is installed
  command: gcc
  register: gcc_error
  changed_when: gcc_error.stderr is search("CommandLineTools")
  ignore_errors: true
  tags: xcode

- name: Include xcode install tasks if needed
  include_tasks: xcode_install.yml
  when: gcc_error.stderr is search("CommandLineTools")
  tags: xcode

- name: Include homebrew install tasks
  include_tasks: homebrew.yml
  tags:
    - docker
    - git
    - homebrew
    - pip
    - ruby

- name: Find Python user bin directory
  shell: python3 -c "import site; print(site.USER_BASE + '/bin')"
  register: python_user_bin
  changed_when: false
  tags: awscli

- name: Add Python user bin to PATH
  set_fact:
    ansible_env: "{{ ansible_env | combine({'PATH': python_user_bin.stdout + ':' + ansible_env.PATH}) }}"
  tags: awscli

- name: Check if pip is installed
  command: pip3 --version
  register: installed_pip_version
  changed_when: installed_pip_version.rc != 0
  ignore_errors: true
  tags:
    - pip

# Only install pip if it's missing
- name: Download pip package
  get_url:
    url: "{{ pip.pkg_location }}"
    dest: /tmp/get-pip.py
    mode: 0755
  when: installed_pip_version.rc != 0
  tags: pip

- name: Remove pip installation file
  file:
    path: /tmp/get-pip.py
    state: absent
  tags: pip

# Always install pip packages
- name: Install setuptools (required by Ansible pip module)
  command: pip3 install --user --break-system-packages setuptools
  tags:
    - awscli
    - pip

- name: Install pip packages
  pip:
    name: "{{ pip.packages }}"
    state: latest
    executable: pip3
    extra_args: --user --break-system-packages
  tags:
    - awscli
    - pip

# - name: Include AWS CLI configuration tasks
#   include_tasks: awscli_config.yml
#   tags: awscli

# - name: Include Docker configuration tasks
#   include_tasks: docker_config.yml
#   tags: docker

# - name: Install gcalcli via pip for root
#   pip:
#     name: gcalcli
#     state: latest
#   become: true
#   tags: gcalcli

- name: Download packages
  get_url:
    url: "{{ item.url }}"
    dest: "{{ item.destination }}"
  with_items: "{{ packages_to_download }}"

- name: Download and unarchive packages
  unarchive:
    src: "{{ item.source }}"
    dest: "{{ item.destination }}"
    remote_src: yes
  with_items: "{{ archives_to_download }}"
  notify: start installed applications

- name: Include rbenv/ruby tasks
  include_tasks: rbenv_and_ruby_install.yml
  tags:
    - rbenv
    - ruby

- name: Include dock-related tasks
  include_tasks: dock_setup.yml
  tags: dock
